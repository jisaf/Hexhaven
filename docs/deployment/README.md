# Deployment Documentation

Complete deployment guides and operational procedures for Hexhaven production environment.

## Quick Links

### Deployment Guides
- [Production Deployment Guide](./PRODUCTION_DEPLOYMENT.md) - Complete production deployment instructions
- [SSL Setup](./SSL_SETUP.md) - HTTPS certificate configuration
- [OCI Network Setup](./OCI_NETWORK_SETUP.md) - Oracle Cloud Infrastructure networking
- [GitHub Deployment Setup](../../.github/DEPLOYMENT_SETUP.md) - GitHub Actions CI/CD configuration

### Troubleshooting
- [Network Troubleshooting](./TROUBLESHOOTING_NETWORK.md) - Network connectivity issues
- [Production Access Fix](./PRODUCTION_ACCESS_FIX.md) - Access and permission issues
- [Terraform Production Fix](./TERRAFORM_PRODUCTION_FIX.md) - Infrastructure issues

---

## Production Environment

### Current Setup
- **Server**: Oracle Cloud Infrastructure (OCI)
- **IP Address**: 150.136.88.138
- **Domain**: (Configure your domain)
- **OS**: Ubuntu 20.04 LTS
- **Node.js**: 20.x
- **Database**: PostgreSQL 14+
- **Web Server**: Nginx
- **Process Manager**: PM2
- **SSL**: Let's Encrypt (Certbot)

### Architecture
```
Internet (Port 80/443)
    ↓
Nginx (Reverse Proxy + Static Files)
    ├─→ / → Frontend (Static Files)
    ├─→ /api → Backend (Port 3000)
    └─→ /socket.io → Backend WebSocket (Port 3000)

Backend → PostgreSQL Database
```

---

## Deployment Methods

### Automated Deployment (Recommended)
Merge to `main` branch triggers automatic deployment via GitHub Actions.

**Steps**:
1. Merge PR to `main` branch
2. GitHub Actions builds and deploys
3. Monitor deployment in Actions tab
4. Verify deployment health checks

### Manual Deployment
Use GitHub Actions workflow dispatch for manual deploys.

**Steps**:
1. Go to GitHub repository
2. Click **Actions** tab
3. Select **Deploy to Production**
4. Click **Run workflow**
5. Select branch and run

### Direct Server Deployment (Emergency)
SSH to server and deploy directly.

**Steps**:
```bash
# SSH to server
ssh ubuntu@150.136.88.138

# Pull latest code
cd /opt/hexhaven
git pull origin main

# Install dependencies
npm install
cd backend && npm install && cd ..
cd frontend && npm install && cd ..

# Build
npm run build

# Restart services
pm2 restart hexhaven-backend
sudo systemctl reload nginx
```

---

## Pre-Deployment Checklist

### Code Quality
- [ ] All tests passing (`npm test`)
- [ ] Linter passing (`npm run lint`)
- [ ] No console errors or warnings
- [ ] Code reviewed and approved
- [ ] Changelog updated

### Database
- [ ] Migrations tested locally
- [ ] Seed data verified
- [ ] Backup created
- [ ] Rollback plan documented

### Configuration
- [ ] Environment variables reviewed
- [ ] Secrets rotated if needed
- [ ] Feature flags configured
- [ ] Rate limits appropriate

### Documentation
- [ ] API docs updated
- [ ] Deployment notes added
- [ ] Known issues documented
- [ ] Runbook updated

---

## Post-Deployment Verification

### Health Checks
```bash
# Check backend health
curl https://your-domain.com/api/health

# Check frontend
curl https://your-domain.com

# Check WebSocket
wscat -c wss://your-domain.com/socket.io
```

### Service Status
```bash
# SSH to server
ssh ubuntu@150.136.88.138

# Check PM2 processes
pm2 status

# Check Nginx
sudo systemctl status nginx

# Check PostgreSQL
sudo systemctl status postgresql

# View backend logs
pm2 logs hexhaven-backend

# View Nginx logs
sudo tail -f /var/log/nginx/error.log
sudo tail -f /var/log/nginx/access.log
```

### Smoke Tests
1. Create a game room
2. Join with second player
3. Start game
4. Complete one action
5. Verify WebSocket updates
6. Check database persistence

---

## Rollback Procedures

### Automatic Rollback
GitHub Actions can rollback failed deployments.

### Manual Rollback
```bash
# SSH to server
ssh ubuntu@150.136.88.138

# Navigate to app directory
cd /opt/hexhaven

# Checkout previous commit
git log  # Find previous commit hash
git checkout <previous-commit-hash>

# Rebuild
npm run build

# Restart services
pm2 restart hexhaven-backend
sudo systemctl reload nginx
```

### Database Rollback
```bash
# Restore from backup
pg_restore -U hexhaven -d hexhaven backup.sql

# Or rollback migrations
cd backend
npx prisma migrate reset
```

---

## Environment Configuration

### Production Environment Variables
Located at `/opt/hexhaven/.env`:

```bash
# Database
DATABASE_URL=postgresql://user:pass@localhost:5432/hexhaven

# Backend
PORT=3000
NODE_ENV=production
FRONTEND_URL=https://your-domain.com

# Session
SESSION_SECRET=<auto-generated-on-deploy>

# (Add other environment variables as needed)
```

### Secrets Management
- Never commit secrets to Git
- Use GitHub Secrets for CI/CD
- Rotate secrets regularly
- Use server-side configuration file

---

## Monitoring & Logging

### Application Logs
```bash
# PM2 logs
pm2 logs hexhaven-backend

# Nginx access logs
sudo tail -f /var/log/nginx/access.log

# Nginx error logs
sudo tail -f /var/log/nginx/error.log

# PostgreSQL logs
sudo tail -f /var/log/postgresql/postgresql-14-main.log
```

### System Monitoring
```bash
# Check disk space
df -h

# Check memory usage
free -h

# Check CPU usage
top

# Check network connections
netstat -tulpn
```

### Performance Metrics
Future integration with:
- Prometheus for metrics
- Grafana for dashboards
- Sentry for error tracking
- LogRocket for session replay

---

## Backup & Recovery

### Database Backups
```bash
# Create backup
pg_dump -U hexhaven hexhaven > backup_$(date +%Y%m%d).sql

# Restore backup
pg_restore -U hexhaven -d hexhaven backup.sql
```

### Application Backups
```bash
# Backup entire application
tar -czf hexhaven_backup_$(date +%Y%m%d).tar.gz /opt/hexhaven

# Restore
tar -xzf hexhaven_backup_YYYYMMDD.tar.gz -C /
```

### Automated Backups
Set up cron job for daily backups:
```bash
# Edit crontab
crontab -e

# Add daily backup at 2 AM
0 2 * * * pg_dump -U hexhaven hexhaven > /backups/hexhaven_$(date +\%Y\%m\%d).sql
```

---

## Security

### Firewall Configuration
```bash
# Check firewall status
sudo ufw status

# Should allow:
# - 22 (SSH)
# - 80 (HTTP)
# - 443 (HTTPS)
```

### SSL/TLS
- Managed by Certbot (Let's Encrypt)
- Auto-renewal configured
- Strong cipher suites
- HTTP → HTTPS redirect

### Access Control
- SSH key-based authentication only
- No password login
- Limited sudo access
- Firewall rules enforced

---

## Scaling Considerations

### Current Capacity
- Single server deployment
- ~100 concurrent sessions
- 1GB database size
- 2 vCPUs, 8GB RAM

### Horizontal Scaling (Future)
- Load balancer (Nginx/HAProxy)
- Multiple backend instances
- Redis for session storage
- CDN for static assets

### Vertical Scaling
- Upgrade server resources
- Optimize database queries
- Add database connection pooling
- Implement caching layers

---

## Disaster Recovery

### Recovery Time Objectives (RTO)
- Critical: <1 hour
- High: <4 hours
- Medium: <24 hours

### Recovery Point Objectives (RPO)
- Database: <1 hour (hourly backups)
- Application: <24 hours (daily backups)

### Disaster Scenarios
1. **Server Failure**: Restore from backup to new server
2. **Database Corruption**: Restore from latest backup
3. **Code Bug**: Rollback to previous deployment
4. **Security Breach**: Isolate, patch, restore from clean backup

---

## Maintenance Windows

### Scheduled Maintenance
- Database updates: Monthly (first Sunday, 2 AM UTC)
- Security patches: As needed
- OS updates: Quarterly
- SSL renewal: Automatic (Let's Encrypt)

### Maintenance Procedure
1. Notify users 24 hours in advance
2. Enable maintenance mode page
3. Stop application services
4. Perform updates
5. Run smoke tests
6. Restore services
7. Monitor for issues

---

## Related Documentation

- [Production Deployment Guide](./PRODUCTION_DEPLOYMENT.md) - Step-by-step deployment
- [SSL Setup](./SSL_SETUP.md) - HTTPS configuration
- [OCI Network Setup](./OCI_NETWORK_SETUP.md) - Infrastructure setup
- [Network Troubleshooting](./TROUBLESHOOTING_NETWORK.md) - Common issues
- [Architecture](../ARCHITECTURE.md) - System architecture overview

---

**Last Updated**: 2025-12-29
**Maintained By**: DevOps Team
**Version**: 1.0.0
